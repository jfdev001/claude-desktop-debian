name: CI
run-name: |
  CI: ${{
    github.event_name == 'pull_request' && format('PR #{0} by @{1} - {2}', github.event.pull_request.number, github.actor, github.event.pull_request.title) ||
    github.event_name == 'push' && github.event.head_commit && format('Push by @{0} - {1}', github.actor, github.event.head_commit.message) ||
    format('{0} triggered by @{1}', github.event_name, github.actor)
  }}

on:
  push:
    branches:
      - main
    paths:
      - "build.sh"
      - "scripts/**"
      - ".github/workflows/**"
    tags:
      - "v*"
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-flags:
    name: Test Flags Parsing
    uses: ./.github/workflows/test-flags.yml

  build-amd64:
    name: Build Packages (amd64 - ${{ matrix.artifact_suffix }})
    needs: test-flags

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            flags: "--build deb"
            artifact_suffix: "deb"
          - arch: amd64
            flags: "--build rpm"
            artifact_suffix: "rpm"
          - arch: amd64
            flags: "--build appimage --clean no"
            artifact_suffix: "appimage"

    uses: ./.github/workflows/build-amd64.yml
    with:
      build_flags: ${{ matrix.flags }}
      artifact_suffix: ${{ matrix.artifact_suffix }}
      release_tag: ${{ startsWith(github.ref, 'refs/tags/v') && github.ref_name || '' }}

  # build-arm64:
  #   name: Build Packages (arm64 - ${{ matrix.artifact_suffix }})
  #   needs: test-flags
  #
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       include:
  #         - arch: arm64
  #           flags: "--build deb --clean no"
  #           artifact_suffix: "deb"
  #         - arch: arm64
  #           flags: "--build rpm"
  #           artifact_suffix: "rpm"
  #         - arch: arm64
  #           flags: "--build appimage"
  #           artifact_suffix: "appimage"
  #
  #   uses: ./.github/workflows/build-arm64.yml
  #   with:
  #     build_flags: ${{ matrix.flags }}
  #     artifact_suffix: ${{ matrix.artifact_suffix }}
  #     release_tag: ${{ startsWith(github.ref, 'refs/tags/v') && github.ref_name || '' }}
  #
  # release:
  #   name: Create Release
  #   if: startsWith(github.ref, 'refs/tags/v')
  #   needs: [test-flags, build-amd64, build-arm64]
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: write
  #
  #   steps:
  #     - name: Download AMD64 deb artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: package-amd64-deb
  #         path: artifacts/
  #
  #     - name: Download AMD64 rpm artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: package-amd64-rpm
  #         path: artifacts/
  #
  #     - name: Download AMD64 AppImage artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: package-amd64-appimage
  #         path: artifacts/
  #
  #     - name: Download ARM64 deb artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: package-arm64-deb
  #         path: artifacts/
  #
  #     - name: Download ARM64 rpm artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: package-arm64-rpm
  #         path: artifacts/
  #
  #     - name: Download ARM64 AppImage artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: package-arm64-appimage
  #         path: artifacts/
  #
  #     - name: Create GitHub Release
  #       uses: softprops/action-gh-release@v2
  #       with:
  #         files: artifacts/**/*
  #
  # update-apt-repo:
  #   name: Update APT Repository
  #   if: startsWith(github.ref, 'refs/tags/v')
  #   needs: [release]
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: write
  #
  #   steps:
  #     - name: Checkout gh-pages branch
  #       uses: actions/checkout@v4
  #       with:
  #         ref: gh-pages
  #         path: apt-repo
  #
  #     - name: Download AMD64 deb artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: package-amd64-deb
  #         path: incoming/
  #
  #     - name: Download ARM64 deb artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: package-arm64-deb
  #         path: incoming/
  #
  #     - name: Install reprepro
  #       run: sudo apt-get update && sudo apt-get install -y reprepro
  #
  #     - name: Import GPG key
  #       uses: crazy-max/ghaction-import-gpg@v6
  #       with:
  #         gpg_private_key: ${{ secrets.APT_GPG_PRIVATE_KEY }}
  #
  #     - name: Add packages to repository
  #       working-directory: apt-repo
  #       run: |
  #         # Remove existing versions to allow re-uploads and wrapper version bumps
  #         # (reprepro rejects new files with same name but different checksums)
  #         for deb in ../incoming/*.deb; do
  #           pkg_name=$(dpkg-deb -f "$deb" Package)
  #           if reprepro list stable "$pkg_name" 2>/dev/null | grep -q .; then
  #             echo "Removing existing $pkg_name from repository..."
  #             reprepro remove stable "$pkg_name"
  #           fi
  #         done
  #
  #         # Add each .deb file to the repository
  #         # --section and --priority provide defaults for older packages missing these fields
  #         for deb in ../incoming/*.deb; do
  #           echo "Adding $deb to repository..."
  #           reprepro --section utils --priority optional includedeb stable "$deb"
  #         done
  #
  #     - name: Commit and push changes
  #       working-directory: apt-repo
  #       run: |
  #         git config user.name "github-actions[bot]"
  #         git config user.email "github-actions[bot]@users.noreply.github.com"
  #         git add -A
  #         git diff --staged --quiet || git commit -m "Update APT repository for ${{ github.ref_name }}"
  #         # Retry loop to handle concurrent pushes to gh-pages
  #         for i in 1 2 3 4 5; do
  #           git pull --rebase && git push && break
  #           echo "Push failed, retrying in 5 seconds... (attempt $i/5)"
  #           sleep 5
  #         done
  #
  # update-dnf-repo:
  #   name: Update DNF Repository
  #   if: startsWith(github.ref, 'refs/tags/v')
  #   needs: [release]
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: write
  #
  #   steps:
  #     - name: Checkout gh-pages branch
  #       uses: actions/checkout@v4
  #       with:
  #         ref: gh-pages
  #         path: dnf-repo
  #
  #     - name: Download AMD64 rpm artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: package-amd64-rpm
  #         path: incoming/
  #
  #     - name: Download ARM64 rpm artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: package-arm64-rpm
  #         path: incoming/
  #
  #     - name: Install createrepo_c and rpm-sign
  #       run: sudo apt-get update && sudo apt-get install -y createrepo-c rpm
  #
  #     - name: Import GPG key
  #       id: import_gpg
  #       uses: crazy-max/ghaction-import-gpg@v6
  #       with:
  #         gpg_private_key: ${{ secrets.APT_GPG_PRIVATE_KEY }}
  #
  #     - name: Configure RPM signing
  #       run: |
  #         # Configure RPM macros for signing
  #         cat > ~/.rpmmacros << EOF
  #         %_signature gpg
  #         %_gpg_name ${{ steps.import_gpg.outputs.keyid }}
  #         %__gpg /usr/bin/gpg
  #         %__gpg_sign_cmd %{__gpg} gpg --batch --no-verbose --no-armor --no-secmem-warning -u "%{_gpg_name}" -sbo %{__signature_filename} %{__plaintext_filename}
  #         EOF
  #
  #     - name: Update DNF repository
  #       working-directory: dnf-repo
  #       run: |
  #         # Create directory structure
  #         mkdir -p rpm/x86_64 rpm/aarch64
  #
  #         # Copy RPMs to appropriate architecture directories
  #         for rpm_file in ../incoming/*.rpm; do
  #           filename=$(basename "$rpm_file")
  #           if [[ "$filename" == *"x86_64"* ]]; then
  #             cp "$rpm_file" rpm/x86_64/
  #             echo "Added $filename to x86_64"
  #           elif [[ "$filename" == *"aarch64"* ]]; then
  #             cp "$rpm_file" rpm/aarch64/
  #             echo "Added $filename to aarch64"
  #           fi
  #         done
  #
  #         # Sign RPM packages and generate repository metadata for each architecture
  #         for arch in x86_64 aarch64; do
  #           if ls rpm/$arch/*.rpm 1> /dev/null 2>&1; then
  #             # Sign each RPM package
  #             echo "Signing RPM packages for $arch..."
  #             for rpm_file in rpm/$arch/*.rpm; do
  #               echo "Signing $rpm_file..."
  #               rpmsign --addsign "$rpm_file"
  #             done
  #
  #             echo "Generating repodata for $arch..."
  #             createrepo_c --update rpm/$arch/
  #
  #             # Sign the repository metadata (--yes to overwrite existing signature)
  #             echo "Signing repodata for $arch..."
  #             gpg --batch --yes --default-key "${{ steps.import_gpg.outputs.keyid }}" --detach-sign --armor rpm/$arch/repodata/repomd.xml
  #           fi
  #         done
  #
  #         # Create .repo file for users (reuses existing KEY.gpg)
  #         printf '%s\n' \
  #           '[claude-desktop]' \
  #           'name=Claude Desktop for Fedora/RHEL' \
  #           'baseurl=https://aaddrick.github.io/claude-desktop-debian/rpm/$basearch' \
  #           'enabled=1' \
  #           'gpgcheck=1' \
  #           'repo_gpgcheck=1' \
  #           'gpgkey=https://aaddrick.github.io/claude-desktop-debian/KEY.gpg' \
  #           > rpm/claude-desktop.repo
  #
  #     - name: Commit and push changes
  #       working-directory: dnf-repo
  #       run: |
  #         git config user.name "github-actions[bot]"
  #         git config user.email "github-actions[bot]@users.noreply.github.com"
  #         git add -A
  #         git diff --staged --quiet || git commit -m "Update DNF repository for ${{ github.ref_name }}"
  #         # Retry loop to handle concurrent pushes to gh-pages
  #         for i in 1 2 3 4 5; do
  #           git pull --rebase && git push && break
  #           echo "Push failed, retrying in 5 seconds... (attempt $i/5)"
  #           sleep 5
  #         done
  #
  # update-aur-repo:
  #   name: Update AUR Package
  #   if: startsWith(github.ref, 'refs/tags/v')
  #   needs: [release]
  #   runs-on: ubuntu-latest
  #
  #   steps:
  #     - name: Download AMD64 AppImage artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: package-amd64-appimage
  #         path: artifacts/
  #
  #     - name: Extract version components from tag
  #       id: version
  #       run: |
  #         tag="${GITHUB_REF_NAME}"
  #         # Tag format: v1.3.8+claude1.1.799
  #         # pkgver for AUR: 1.3.8+claude1.1.799
  #         pkgver="${tag#v}"
  #         # Wrapper version: 1.3.8 (before +claude)
  #         wrapper_ver="${pkgver%%+claude*}"
  #         # Claude version: 1.1.799 (after +claude)
  #         claude_ver="${pkgver#*+claude}"
  #         # AppImage filename: claude-desktop-{claude_ver}-{wrapper_ver}-amd64.AppImage
  #         appimage_name="claude-desktop-${claude_ver}-${wrapper_ver}-amd64.AppImage"
  #
  #         echo "pkgver=$pkgver" >> "$GITHUB_OUTPUT"
  #         echo "appimage_name=$appimage_name" >> "$GITHUB_OUTPUT"
  #         echo "Tag: $tag"
  #         echo "pkgver: $pkgver"
  #         echo "AppImage name: $appimage_name"
  #
  #     - name: Compute AppImage checksum
  #       id: checksum
  #       env:
  #         APPIMAGE_NAME: ${{ steps.version.outputs.appimage_name }}
  #       run: |
  #         appimage="artifacts/${APPIMAGE_NAME}"
  #         if [[ ! -f "$appimage" ]]; then
  #           echo "::error::Expected AppImage not found: ${APPIMAGE_NAME}"
  #           echo "Available artifacts:"
  #           ls -la artifacts/
  #           exit 1
  #         fi
  #         sha256=$(sha256sum "$appimage" | awk '{print $1}')
  #         echo "sha256=$sha256" >> "$GITHUB_OUTPUT"
  #         echo "AppImage: ${APPIMAGE_NAME}"
  #         echo "SHA256: $sha256"
  #
  #     - name: Configure SSH for AUR
  #       env:
  #         AUR_SSH_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
  #       run: |
  #         if [[ -z "$AUR_SSH_KEY" ]]; then
  #           echo "::error::AUR_SSH_PRIVATE_KEY secret is not configured"
  #           exit 1
  #         fi
  #         mkdir -p ~/.ssh
  #         echo "$AUR_SSH_KEY" > ~/.ssh/aur
  #         chmod 600 ~/.ssh/aur
  #         ssh-keyscan -t ed25519,rsa aur.archlinux.org >> ~/.ssh/known_hosts 2>/dev/null
  #         cat > ~/.ssh/config <<-'EOF'
  #         Host aur.archlinux.org
  #           IdentityFile ~/.ssh/aur
  #           User aur
  #         EOF
  #         chmod 600 ~/.ssh/config
  #
  #     - name: Clone AUR repository
  #       run: |
  #         git clone ssh://aur@aur.archlinux.org/claude-desktop-appimage.git aur-repo
  #
  #     - name: Generate PKGBUILD from template
  #       working-directory: aur-repo
  #       env:
  #         PKGVER: ${{ steps.version.outputs.pkgver }}
  #         APPIMAGE_NAME: ${{ steps.version.outputs.appimage_name }}
  #         SHA256: ${{ steps.checksum.outputs.sha256 }}
  #       run: |
  #         if [[ ! -f PKGBUILD.template ]]; then
  #           echo "::error::PKGBUILD.template not found in AUR repository"
  #           exit 1
  #         fi
  #
  #         sed \
  #           -e "s/%%PKGVER%%/${PKGVER}/" \
  #           -e "s/%%APPIMAGE_NAME%%/${APPIMAGE_NAME}/" \
  #           -e "s/%%SHA256_APPIMAGE%%/${SHA256}/" \
  #           PKGBUILD.template > PKGBUILD
  #
  #     - name: Generate .SRCINFO
  #       working-directory: aur-repo
  #       run: |
  #         docker run --rm -v "$PWD":/pkg -w /pkg archlinux:base bash -c "
  #           useradd -m builder
  #           chown builder:builder /pkg
  #           find /pkg -maxdepth 1 -not -name .git -not -path /pkg -exec chown -R builder:builder {} +
  #           su builder -c 'makepkg --printsrcinfo > .SRCINFO'
  #         "
  #         # Restore ownership after docker (container uid may differ from runner)
  #         sudo chown -R "$(id -u):$(id -g)" .
  #
  #     - name: Commit and push to AUR
  #       working-directory: aur-repo
  #       env:
  #         PKGVER: ${{ steps.version.outputs.pkgver }}
  #       run: |
  #         git config user.name "github-actions[bot]"
  #         git config user.email "github-actions[bot]@users.noreply.github.com"
  #         git add PKGBUILD .SRCINFO
  #         if git diff --staged --quiet; then
  #           echo "No changes to commit"
  #           exit 0
  #         fi
  #         git commit -m "Update to v${PKGVER}"
  #         git push
